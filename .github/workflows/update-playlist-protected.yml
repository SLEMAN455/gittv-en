# TÃªn tá»‡p: .github/workflows/update-playlist-protected.yml

name: Update IPTV Playlist (Zero Downtime - Protected)

on:
  schedule:
    # Cháº¡y 4 láº§n/ngÃ y vÃ o cÃ¡c thá»i Ä‘iá»ƒm tá»‘i Æ°u
    - cron: '0 3,9,15,21 * * *'
  
  workflow_dispatch:
    inputs:
      mode:
        description: 'Cháº¿ Ä‘á»™ cháº¡y (normal/quick/express)'
        required: false
        default: 'normal'
        type: choice
        options:
          - normal
          - quick
          - express

permissions:
  contents: write

# NgÄƒn cháº·n cÃ¡c láº§n cháº¡y chá»“ng chÃ©o, Ä‘áº£m báº£o tÃ­nh toÃ n váº¹n
concurrency:
  group: playlist-update
  cancel-in-progress: false

env:
  PYTHON_VERSION: '3.11'
  OUTPUT_FILENAME: 'playlist.m3u'
  PROTECTED_FILENAME: 'playlist.zip'
  BACKUP_FILENAME: 'playlist.zip.backup'

jobs:
  update-playlist:
    name: Update & Protect Playlist
    runs-on: ubuntu-latest
    timeout-minutes: 25 # Giá»›i háº¡n thá»i gian cháº¡y tá»‘i Ä‘a
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python with Cache
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install Dependencies
        run: pip install --no-cache-dir aiohttp
      
      - name: Configure Run Mode
        run: |
          MODE="${{ github.event.inputs.mode }}"
          if [ "$MODE" == "quick" ]; then
            sed -i 's/CHANNEL_CHECK_TIMEOUT = 8/CHANNEL_CHECK_TIMEOUT = 6/g' iptv_generator_optimized.py
            sed -i 's/MAX_CONCURRENT_CHECKS = 40/MAX_CONCURRENT_CHECKS = 50/g' iptv_generator_optimized.py
            echo "âš¡ Cháº¿ Ä‘á»™ Quick: timeout 6s, 50 káº¿t ná»‘i Ä‘á»“ng thá»i"
          elif [ "$MODE" == "express" ]; then
            sed -i 's/CHANNEL_CHECK_TIMEOUT = 8/CHANNEL_CHECK_TIMEOUT = 4/g' iptv_generator_optimized.py
            sed -i 's/MAX_CONCURRENT_CHECKS = 40/MAX_CONCURRENT_CHECKS = 60/g' iptv_generator_optimized.py
            echo "ðŸš€ Cháº¿ Ä‘á»™ Express: timeout 4s, 60 káº¿t ná»‘i Ä‘á»“ng thá»i"
          else
            echo "ðŸ”„ Cháº¿ Ä‘á»™ Normal: timeout 8s, 40 káº¿t ná»‘i Ä‘á»“ng thá»i"
          fi

      - name: Backup Current Protected Playlist
        id: backup
        run: |
          if [ -f "${{ env.PROTECTED_FILENAME }}" ]; then
            cp "${{ env.PROTECTED_FILENAME }}" "${{ env.BACKUP_FILENAME }}"
            echo "ðŸ“¦ ÄÃ£ sao lÆ°u playlist hiá»‡n táº¡i vÃ o ${{ env.BACKUP_FILENAME }}"
            echo "has_backup=true" >> $GITHUB_OUTPUT
          else
            echo "ðŸ†• Láº§n cháº¡y Ä‘áº§u tiÃªn, khÃ´ng cÃ³ gÃ¬ Ä‘á»ƒ sao lÆ°u."
            echo "has_backup=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Generate New Playlist
        run: python iptv_generator_optimized.py
      
      - name: Validate New Playlist
        id: validate
        run: |
          if [ ! -f "${{ env.OUTPUT_FILENAME }}" ]; then
            echo "valid=false" >> $GITHUB_OUTPUT
            echo "âŒ Lá»—i: Script khÃ´ng táº¡o ra tá»‡p playlist.m3u."
            exit 0
          fi
          
          NEW_CHANNELS=$(grep -c "^http" "${{ env.OUTPUT_FILENAME }}" || echo "0")
          # YÃªu cáº§u tá»‘i thiá»ƒu 50 kÃªnh Ä‘á»ƒ coi lÃ  há»£p lá»‡
          if [ $NEW_CHANNELS -lt 50 ]; then
            echo "valid=false" >> $GITHUB_OUTPUT
            echo "âŒ XÃ¡c thá»±c tháº¥t báº¡i: Sá»‘ lÆ°á»£ng kÃªnh quÃ¡ Ã­t ($NEW_CHANNELS). Sá»­ dá»¥ng báº£n sao lÆ°u náº¿u cÃ³."
            exit 0
          fi
          
          echo "valid=true" >> $GITHUB_OUTPUT
          echo "channels=$NEW_CHANNELS" >> $GITHUB_OUTPUT
          echo "âœ… Playlist má»›i há»£p lá»‡ vá»›i $NEW_CHANNELS kÃªnh."

      - name: Protect Playlist with Password
        if: steps.validate.outputs.valid == 'true'
        run: |
          sudo apt-get update && sudo apt-get install -y zip
          zip -P "${{ secrets.PLAYLIST_PASSWORD }}" -j "${{ env.PROTECTED_FILENAME }}" "${{ env.OUTPUT_FILENAME }}"
          echo "ðŸ” ÄÃ£ nÃ©n vÃ  báº£o vá»‡ tá»‡p playlist.zip thÃ nh cÃ´ng."

      - name: Rollback if Validation Failed
        if: steps.validate.outputs.valid == 'false' && steps.backup.outputs.has_backup == 'true'
        run: |
          echo "âš ï¸ KhÃ´i phá»¥c playlist tá»« báº£n sao lÆ°u..."
          mv "${{ env.BACKUP_FILENAME }}" "${{ env.PROTECTED_FILENAME }}"
          echo "âœ… ÄÃ£ khÃ´i phá»¥c thÃ nh cÃ´ng."

      - name: Generate README
        if: steps.validate.outputs.valid == 'true'
        run: |
          CHANNELS="${{ steps.validate.outputs.channels }}"
          UPDATED_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          cat > README.md << EOF
          # ðŸ“º IPTV Playlist Generator (Protected)

          ![Status](https://github.com/${{ github.repository }}/actions/workflows/update-playlist-protected.yml/badge.svg)
          ![Channels](https://img.shields.io/badge/channels-${CHANNELS}-success)
          ![Protected](https://img.shields.io/badge/protection-password-brightgreen)
          ![Last Updated](https://img.shields.io/badge/updated-${UPDATED_TIME// /-}-blue)

          ## ðŸš€ Táº£i Playlist ÄÆ°á»£c Báº£o Vá»‡

          1.  **Táº£i file:**
              \`\`\`
              https://raw.githubusercontent.com/${{ github.repository }}/main/${{ env.PROTECTED_FILENAME }}
              \`\`\`
          2.  **Giáº£i nÃ©n:** Sá»­ dá»¥ng máº­t kháº©u Ä‘Ã£ Ä‘Æ°á»£c cung cáº¥p Ä‘á»ƒ giáº£i nÃ©n file \`${{ env.PROTECTED_FILENAME }}\` vÃ  nháº­n file \`${{ env.OUTPUT_FILENAME }}\`.
          3.  **Sá»­ dá»¥ng:** ThÃªm file \`${{ env.OUTPUT_FILENAME }}\` vÃ o trÃ¬nh phÃ¡t IPTV cá»§a báº¡n (VLC, Kodi, TiviMate, etc.).

          **LÆ°u Ã½:** Playlist Ä‘Æ°á»£c cáº­p nháº­t tá»± Ä‘á»™ng 4 láº§n má»—i ngÃ y. Báº¡n sáº½ cáº§n táº£i láº¡i vÃ  giáº£i nÃ©n file má»›i Ä‘á»ƒ cÃ³ danh sÃ¡ch kÃªnh má»›i nháº¥t.

          ## ðŸ” CÆ¡ Cháº¿ Báº£o Vá»‡

          - Playlist cuá»‘i cÃ¹ng Ä‘Æ°á»£c nÃ©n vÃ o má»™t file \`.zip\` vÃ  Ä‘Æ°á»£c mÃ£ hÃ³a báº±ng máº­t kháº©u.
          - Máº­t kháº©u Ä‘Æ°á»£c lÆ°u trá»¯ an toÃ n trong **GitHub Secrets** vÃ  khÃ´ng bao giá» bá»‹ lá»™ ra ngoÃ i.
          - Chá»‰ nhá»¯ng ngÆ°á»i biáº¿t máº­t kháº©u má»›i cÃ³ thá»ƒ truy cáº­p danh sÃ¡ch kÃªnh.

          ---
          *Generated by GitHub Actions - Zero Downtime & Protected*
          EOF
      
      - name: Commit Protected Playlist
        if: steps.validate.outputs.valid == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ðŸ”„ Update: ${{ steps.validate.outputs.channels }} channels (Protected)"
          file_pattern: "${{ env.PROTECTED_FILENAME }} README.md iptv_generator.log"
          commit_user_name: IPTV Bot
          commit_user_email: actions@github.com

      - name: Cleanup Temporary Files
        if: always() # LuÃ´n cháº¡y bÆ°á»›c nÃ y Ä‘á»ƒ dá»n dáº¹p
        run: |
          rm -f "${{ env.OUTPUT_FILENAME }}" "${{ env.BACKUP_FILENAME }}"
          echo "ðŸ§¹ ÄÃ£ dá»n dáº¹p cÃ¡c tá»‡p táº¡m thá»i."
