# Tên tệp: .github/workflows/update-playlist-public.yml

name: Update IPTV Playlist (Public URL - Auto Refresh)

on:
  schedule:
    # THAY ĐỔI: Chạy 2 lần/ngày vào 9h sáng và 9h tối (giờ UTC)
    - cron: '0 9,21 * * *'
  
  workflow_dispatch:
    inputs:
      mode:
        description: 'Chế độ chạy (normal/quick/express)'
        required: false
        default: 'normal'
        type: choice
        options:
          - normal
          - quick
          - express

permissions:
  contents: write

concurrency:
  group: playlist-update
  cancel-in-progress: false

env:
  PYTHON_VERSION: '3.11'
  OUTPUT_FILENAME: 'playlist.m3u'

jobs:
  update-playlist:
    name: Generate Public Playlist
    runs-on: ubuntu-latest
    # THÊM: Giới hạn thời gian chạy an toàn là 45 phút
    timeout-minutes: 45
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          # Lấy lịch sử commit để có thể khôi phục nếu cần (dù logic hiện tại là không commit file xấu)
          fetch-depth: 2

      - name: Setup Python with Cache
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install Dependencies
        run: pip install -r requirements.txt
      
      - name: Configure Run Mode
        run: |
          # Chế độ chạy tùy chọn này chỉ có tác dụng khi chạy thủ công (workflow_dispatch)
          MODE="${{ github.event.inputs.mode }}"
          if [ "$MODE" == "quick" ]; then
            sed -i 's/CHANNEL_CHECK_TIMEOUT = 4/CHANNEL_CHECK_TIMEOUT = 3/g' iptv_generator_optimized.py
            sed -i 's/MAX_CONCURRENT_CHECKS = 100/MAX_CONCURRENT_CHECKS = 120/g' iptv_generator_optimized.py
            echo "⚡ Chế độ Quick được kích hoạt."
          elif [ "$MODE" == "express" ]; then
            sed -i 's/CHANNEL_CHECK_TIMEOUT = 4/CHANNEL_CHECK_TIMEOUT = 2/g' iptv_generator_optimized.py
            sed -i 's/MAX_CONCURRENT_CHECKS = 100/MAX_CONCURRENT_CHECKS = 150/g' iptv_generator_optimized.py
            echo "🚀 Chế độ Express được kích hoạt."
          else
            echo "🔄 Chạy ở chế độ Normal (đã tối ưu hóa)."
          fi
      
      - name: Generate New Playlist
        run: python iptv_generator_optimized.py
      
      - name: Validate New Playlist
        id: validate
        run: |
          if [ ! -f "${{ env.OUTPUT_FILENAME }}" ]; then
            echo "❌ Lỗi: Script không tạo ra tệp playlist.m3u."
            exit 1
          fi
          
          NEW_CHANNELS=$(grep -c "^http" "${{ env.OUTPUT_FILENAME }}" || echo "0")
          # Yêu cầu tối thiểu 50 kênh để coi là hợp lệ
          if [ $NEW_CHANNELS -lt 50 ]; then
            echo "❌ Xác thực thất bại: Số lượng kênh quá ít ($NEW_CHANNELS)."
            echo "Để bảo toàn chất lượng, lần cập nhật này sẽ bị hủy và giữ lại playlist cũ."
            exit 1
          fi
          
          echo "✅ Playlist mới hợp lệ với $NEW_CHANNELS kênh."
          echo "channels=$NEW_CHANNELS" >> $GITHUB_OUTPUT

      - name: Generate README
        run: |
          CHANNELS="${{ steps.validate.outputs.channels }}"
          UPDATED_TIME=$(date -u +"%Y-%m-%d %H:%M UTC")
          cat > README.md << EOF
          # 📺 IPTV Playlist Generator (Auto Refresh)

          ![Status](https://github.com/${{ github.repository }}/actions/workflows/update-playlist-public.yml/badge.svg)
          ![Channels](https://img.shields.io/badge/channels-${CHANNELS}-success)
          ![Last Updated](https://img.shields.io/badge/updated-${UPDATED_TIME// /%20}-blue)

          ## 🚀 URL Playlist Tự Động Cập Nhật

          Dán đường link dưới đây vào trình phát IPTV của bạn một lần duy nhất. Playlist sẽ tự động được làm mới theo lịch trình.

          \`\`\`
          https://raw.githubusercontent.com/${{ github.repository }}/main/${{ env.OUTPUT_FILENAME }}
          \`\`\`

          ### Hướng dẫn
          1.  **Sao chép** đường link trên.
          2.  Mở trình phát IPTV (VLC, Kodi, TiviMate, Perfect Player...).
          3.  Chọn "Add Playlist from URL", "Mở luồng mạng (Open Network Stream)" hoặc chức năng tương tự.
          4.  **Dán** đường link vào và xác nhận.

          ### Lịch trình cập nhật
          - Playlist được tự động làm mới **2 lần mỗi ngày** vào lúc **09:00** và **21:00** (giờ UTC).

          ---
          *Generated by GitHub Actions*
          EOF
      
      - name: Commit Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "🔄 Update: ${{ steps.validate.outputs.channels }} channels"
          file_pattern: "${{ env.OUTPUT_FILENAME }} README.md iptv_generator.log"
          commit_user_name: IPTV Bot
          commit_user_email: actions@github.com
