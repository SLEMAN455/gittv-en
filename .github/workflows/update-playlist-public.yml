name: Update IPTV Playlist (High Quality - Auto Refresh)

on:
  schedule:
    - cron: '0 9,21 * * *'
  
  workflow_dispatch:
    inputs:
      mode:
        description: 'Cháº¿ Ä‘á»™ cháº¡y (normal/quick/express)'
        required: false
        default: 'normal'
        type: choice
        options:
          - normal
          - quick
          - express

permissions:
  contents: write

concurrency:
  group: playlist-update
  cancel-in-progress: false

env:
  PYTHON_VERSION: '3.11'
  OUTPUT_FILENAME: 'playlist.m3u'

jobs:
  update-playlist:
    name: Generate High-Quality Playlist
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Python with Cache
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install Dependencies
        run: pip install -r requirements.txt
      
      - name: Configure Run Mode
        run: |
          MODE="${{ github.event.inputs.mode }}"
          if [ "$MODE" == "quick" ]; then
            sed -i 's/CHANNEL_CHECK_TIMEOUT = 5/CHANNEL_CHECK_TIMEOUT = 3/g' iptv_generator_optimized.py
            sed -i 's/MAX_CONCURRENT_CHECKS = 150/MAX_CONCURRENT_CHECKS = 180/g' iptv_generator_optimized.py
            echo "âš¡ Cháº¿ Ä‘á»™ Quick Ä‘Æ°á»£c kÃ­ch hoáº¡t."
          elif [ "$MODE" == "express" ]; then
            sed -i 's/CHANNEL_CHECK_TIMEOUT = 5/CHANNEL_CHECK_TIMEOUT = 2/g' iptv_generator_optimized.py
            sed -i 's/MAX_CONCURRENT_CHECKS = 150/MAX_CONCURRENT_CHECKS = 200/g' iptv_generator_optimized.py
            echo "ðŸš€ Cháº¿ Ä‘á»™ Express Ä‘Æ°á»£c kÃ­ch hoáº¡t."
          else
            echo "ðŸ”„ Cháº¡y á»Ÿ cháº¿ Ä‘á»™ Normal (High Quality Mode)."
          fi
      
      - name: Generate High-Quality Playlist
        run: python iptv_generator_optimized.py
      
      - name: Validate New Playlist
        id: validate
        run: |
          if [ ! -f "${{ env.OUTPUT_FILENAME }}" ]; then
            echo "âŒ Lá»—i: Script khÃ´ng táº¡o ra tá»‡p playlist.m3u."
            exit 1
          fi
          
          NEW_CHANNELS=$(grep -c "^http" "${{ env.OUTPUT_FILENAME }}" || echo "0")
          if [ $NEW_CHANNELS -lt 30 ]; then
            echo "âŒ XÃ¡c thá»±c tháº¥t báº¡i: Sá»‘ lÆ°á»£ng kÃªnh quÃ¡ Ã­t ($NEW_CHANNELS)."
            echo "Äá»ƒ báº£o toÃ n cháº¥t lÆ°á»£ng, láº§n cáº­p nháº­t nÃ y sáº½ bá»‹ há»§y vÃ  giá»¯ láº¡i playlist cÅ©."
            exit 1
          fi
          
          echo "âœ… Playlist má»›i há»£p lá»‡ vá»›i $NEW_CHANNELS kÃªnh cháº¥t lÆ°á»£ng cao."
          echo "channels=$NEW_CHANNELS" >> $GITHUB_OUTPUT

      - name: Generate README
        run: |
          CHANNELS="${{ steps.validate.outputs.channels }}"
          UPDATED_TIME=$(date -u +"%Y-%m-%d %H:%M UTC")
          cat > README.md << EOF
          # ðŸ“º IPTV Playlist Generator (High Quality - Auto Refresh)

          ![Status](https://github.com/${{ github.repository }}/actions/workflows/update-playlist-public.yml/badge.svg)
          ![Channels](https://img.shields.io/badge/channels-${CHANNELS}-success)
          ![Quality](https://img.shields.io/badge/quality-1080p+-blue)
          ![Last Updated](https://img.shields.io/badge/updated-${UPDATED_TIME// /%20}-blue)

          ## ðŸš€ URL Playlist Cháº¥t LÆ°á»£ng Cao

          **Chá»‰ chá»©a kÃªnh â‰¥1080p, ping nhanh, khÃ´ng cÃ³ kÃªnh cháº¥t lÆ°á»£ng tháº¥p.**

          \`\`\`
          https://raw.githubusercontent.com/${{ github.repository }}/main/${{ env.OUTPUT_FILENAME }}
          \`\`\`

          ### âœ¨ Äáº·c Ä‘iá»ƒm
          - âœ… **Cháº¥t lÆ°á»£ng:** Táº¥t cáº£ kÃªnh â‰¥ 1080p (FHD/4K)
          - âš¡ **Tá»‘c Ä‘á»™:** Ping â‰¤ 3400ms (nhanh hÆ¡n 15%)
          - ðŸš« **Loáº¡i bá»:** Bangladesh, Belarus, Costa Rica, India, Mexico, Laos
          - ðŸŽ¯ **Tá»•ng sá»‘ kÃªnh:** ${CHANNELS} kÃªnh Ä‘Æ°á»£c tuyá»ƒn chá»n

          ### HÆ°á»›ng dáº«n sá»­ dá»¥ng
          1.  **Sao chÃ©p** Ä‘Æ°á»ng link trÃªn.
          2.  Má»Ÿ trÃ¬nh phÃ¡t IPTV (VLC, Kodi, TiviMate, Perfect Player...).
          3.  Chá»n "Add Playlist from URL" hoáº·c "Má»Ÿ luá»“ng máº¡ng".
          4.  **DÃ¡n** Ä‘Æ°á»ng link vÃ o vÃ  xÃ¡c nháº­n.

          ### Lá»‹ch trÃ¬nh cáº­p nháº­t
          - Playlist Ä‘Æ°á»£c tá»± Ä‘á»™ng lÃ m má»›i **2 láº§n má»—i ngÃ y** vÃ o lÃºc **09:00** vÃ  **21:00** (giá» UTC).
          - Chá»‰ giá»¯ láº¡i cÃ¡c kÃªnh Ä‘áº¡t tiÃªu chuáº©n cháº¥t lÆ°á»£ng cao.

          ---
          *Generated by GitHub Actions - High Quality Mode*
          EOF
      
      - name: Commit Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ðŸ”„ Update: ${{ steps.validate.outputs.channels }} HQ channels (â‰¥1080p)"
          file_pattern: "${{ env.OUTPUT_FILENAME }} README.md iptv_generator.log"
          commit_user_name: IPTV Bot
          commit_user_email: actions@github.com
