# TÃªn tá»‡p: .github/workflows/update-playlist-public.yml

name: Update IPTV Playlist (Public URL - Auto Refresh)

on:
  schedule:
    # THAY Äá»”I: Cháº¡y 2 láº§n/ngÃ y vÃ o 9h sÃ¡ng vÃ  9h tá»‘i (giá» UTC)
    - cron: '0 9,21 * * *'
  
  workflow_dispatch:
    inputs:
      mode:
        description: 'Cháº¿ Ä‘á»™ cháº¡y (normal/quick/express)'
        required: false
        default: 'normal'
        type: choice
        options:
          - normal
          - quick
          - express

permissions:
  contents: write

concurrency:
  group: playlist-update
  cancel-in-progress: false

env:
  PYTHON_VERSION: '3.11'
  OUTPUT_FILENAME: 'playlist.m3u'

jobs:
  update-playlist:
    name: Generate Public Playlist
    runs-on: ubuntu-latest
    # THÃŠM: Giá»›i háº¡n thá»i gian cháº¡y an toÃ n lÃ  45 phÃºt
    timeout-minutes: 45
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          # Láº¥y lá»‹ch sá»­ commit Ä‘á»ƒ cÃ³ thá»ƒ khÃ´i phá»¥c náº¿u cáº§n (dÃ¹ logic hiá»‡n táº¡i lÃ  khÃ´ng commit file xáº¥u)
          fetch-depth: 2

      - name: Setup Python with Cache
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install Dependencies
        run: pip install -r requirements.txt
      
      - name: Configure Run Mode
        run: |
          # Cháº¿ Ä‘á»™ cháº¡y tÃ¹y chá»n nÃ y chá»‰ cÃ³ tÃ¡c dá»¥ng khi cháº¡y thá»§ cÃ´ng (workflow_dispatch)
          MODE="${{ github.event.inputs.mode }}"
          if [ "$MODE" == "quick" ]; then
            sed -i 's/CHANNEL_CHECK_TIMEOUT = 4/CHANNEL_CHECK_TIMEOUT = 3/g' iptv_generator_optimized.py
            sed -i 's/MAX_CONCURRENT_CHECKS = 100/MAX_CONCURRENT_CHECKS = 120/g' iptv_generator_optimized.py
            echo "âš¡ Cháº¿ Ä‘á»™ Quick Ä‘Æ°á»£c kÃ­ch hoáº¡t."
          elif [ "$MODE" == "express" ]; then
            sed -i 's/CHANNEL_CHECK_TIMEOUT = 4/CHANNEL_CHECK_TIMEOUT = 2/g' iptv_generator_optimized.py
            sed -i 's/MAX_CONCURRENT_CHECKS = 100/MAX_CONCURRENT_CHECKS = 150/g' iptv_generator_optimized.py
            echo "ðŸš€ Cháº¿ Ä‘á»™ Express Ä‘Æ°á»£c kÃ­ch hoáº¡t."
          else
            echo "ðŸ”„ Cháº¡y á»Ÿ cháº¿ Ä‘á»™ Normal (Ä‘Ã£ tá»‘i Æ°u hÃ³a)."
          fi
      
      - name: Generate New Playlist
        run: python iptv_generator_optimized.py
      
      - name: Validate New Playlist
        id: validate
        run: |
          if [ ! -f "${{ env.OUTPUT_FILENAME }}" ]; then
            echo "âŒ Lá»—i: Script khÃ´ng táº¡o ra tá»‡p playlist.m3u."
            exit 1
          fi
          
          NEW_CHANNELS=$(grep -c "^http" "${{ env.OUTPUT_FILENAME }}" || echo "0")
          # YÃªu cáº§u tá»‘i thiá»ƒu 50 kÃªnh Ä‘á»ƒ coi lÃ  há»£p lá»‡
          if [ $NEW_CHANNELS -lt 50 ]; then
            echo "âŒ XÃ¡c thá»±c tháº¥t báº¡i: Sá»‘ lÆ°á»£ng kÃªnh quÃ¡ Ã­t ($NEW_CHANNELS)."
            echo "Äá»ƒ báº£o toÃ n cháº¥t lÆ°á»£ng, láº§n cáº­p nháº­t nÃ y sáº½ bá»‹ há»§y vÃ  giá»¯ láº¡i playlist cÅ©."
            exit 1
          fi
          
          echo "âœ… Playlist má»›i há»£p lá»‡ vá»›i $NEW_CHANNELS kÃªnh."
          echo "channels=$NEW_CHANNELS" >> $GITHUB_OUTPUT

      - name: Generate README
        run: |
          CHANNELS="${{ steps.validate.outputs.channels }}"
          UPDATED_TIME=$(date -u +"%Y-%m-%d %H:%M UTC")
          cat > README.md << EOF
          # ðŸ“º IPTV Playlist Generator (Auto Refresh)

          ![Status](https://github.com/${{ github.repository }}/actions/workflows/update-playlist-public.yml/badge.svg)
          ![Channels](https://img.shields.io/badge/channels-${CHANNELS}-success)
          ![Last Updated](https://img.shields.io/badge/updated-${UPDATED_TIME// /%20}-blue)

          ## ðŸš€ URL Playlist Tá»± Äá»™ng Cáº­p Nháº­t

          DÃ¡n Ä‘Æ°á»ng link dÆ°á»›i Ä‘Ã¢y vÃ o trÃ¬nh phÃ¡t IPTV cá»§a báº¡n má»™t láº§n duy nháº¥t. Playlist sáº½ tá»± Ä‘á»™ng Ä‘Æ°á»£c lÃ m má»›i theo lá»‹ch trÃ¬nh.

          \`\`\`
          https://raw.githubusercontent.com/${{ github.repository }}/main/${{ env.OUTPUT_FILENAME }}
          \`\`\`

          ### HÆ°á»›ng dáº«n
          1.  **Sao chÃ©p** Ä‘Æ°á»ng link trÃªn.
          2.  Má»Ÿ trÃ¬nh phÃ¡t IPTV (VLC, Kodi, TiviMate, Perfect Player...).
          3.  Chá»n "Add Playlist from URL", "Má»Ÿ luá»“ng máº¡ng (Open Network Stream)" hoáº·c chá»©c nÄƒng tÆ°Æ¡ng tá»±.
          4.  **DÃ¡n** Ä‘Æ°á»ng link vÃ o vÃ  xÃ¡c nháº­n.

          ### Lá»‹ch trÃ¬nh cáº­p nháº­t
          - Playlist Ä‘Æ°á»£c tá»± Ä‘á»™ng lÃ m má»›i **2 láº§n má»—i ngÃ y** vÃ o lÃºc **09:00** vÃ  **21:00** (giá» UTC).

          ---
          *Generated by GitHub Actions*
          EOF
      
      - name: Commit Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ðŸ”„ Update: ${{ steps.validate.outputs.channels }} channels"
          file_pattern: "${{ env.OUTPUT_FILENAME }} README.md iptv_generator.log"
          commit_user_name: IPTV Bot
          commit_user_email: actions@github.com
