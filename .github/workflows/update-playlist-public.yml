name: Update IPTV Playlist (Public URL - Auto Refresh)

on:
  schedule:
    # Cháº¡y 2 láº§n/ngÃ y vÃ o cÃ¡c thá»i Ä‘iá»ƒm tá»‘i Æ°u
    - cron: '0 21,9 * * *'
  
  workflow_dispatch:
    inputs:
      mode:
        description: 'Cháº¿ Ä‘á»™ cháº¡y (normal/quick/express)'
        required: false
        default: 'normal'
        type: choice
        options:
          - normal
          - quick
          - express

permissions:
  contents: write

concurrency:
  group: playlist-update
  cancel-in-progress: false

env:
  PYTHON_VERSION: '3.11'
  OUTPUT_FILENAME: 'playlist.m3u'

jobs:
  update-playlist:
    name: Generate Public Playlist
    runs-on: ubuntu-latest
    timeout-minutes: 25
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          # Láº¥y lá»‹ch sá»­ commit Ä‘á»ƒ so sÃ¡nh cháº¥t lÆ°á»£ng playlist
          fetch-depth: 2

      - name: Setup Python with Cache
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install Dependencies
        run: pip install -r requirements.txt
      
      - name: Configure Run Mode
        run: |
          MODE="${{ github.event.inputs.mode }}"
          # (Pháº§n cáº¥u hÃ¬nh cháº¿ Ä‘á»™ cháº¡y giá»¯ nguyÃªn nhÆ° trÆ°á»›c)
          if [ "$MODE" == "quick" ]; then
            sed -i 's/CHANNEL_CHECK_TIMEOUT = 8/CHANNEL_CHECK_TIMEOUT = 6/g' iptv_generator_optimized.py
            sed -i 's/MAX_CONCURRENT_CHECKS = 40/MAX_CONCURRENT_CHECKS = 50/g' iptv_generator_optimized.py
          elif [ "$MODE" == "express" ]; then
            sed -i 's/CHANNEL_CHECK_TIMEOUT = 8/CHANNEL_CHECK_TIMEOUT = 4/g' iptv_generator_optimized.py
            sed -i 's/MAX_CONCURRENT_CHECKS = 40/MAX_CONCURRENT_CHECKS = 60/g' iptv_generator_optimized.py
          fi
      
      - name: Generate New Playlist
        run: python iptv_generator_optimized.py
      
      - name: Validate New Playlist
        id: validate
        run: |
          if [ ! -f "${{ env.OUTPUT_FILENAME }}" ]; then
            echo "âŒ Lá»—i: Script khÃ´ng táº¡o ra tá»‡p playlist.m3u."
            exit 1
          fi
          
          NEW_CHANNELS=$(grep -c "^http" "${{ env.OUTPUT_FILENAME }}" || echo "0")
          # YÃªu cáº§u tá»‘i thiá»ƒu 50 kÃªnh Ä‘á»ƒ coi lÃ  há»£p lá»‡
          if [ $NEW_CHANNELS -lt 50 ]; then
            echo "âŒ XÃ¡c thá»±c tháº¥t báº¡i: Sá»‘ lÆ°á»£ng kÃªnh quÃ¡ Ã­t ($NEW_CHANNELS)."
            # KhÃ´ng commit vÃ  thoÃ¡t Ä‘á»ƒ giá»¯ láº¡i phiÃªn báº£n cÅ© tá»‘t hÆ¡n
            exit 1
          fi
          
          echo "âœ… Playlist má»›i há»£p lá»‡ vá»›i $NEW_CHANNELS kÃªnh."
          echo "channels=$NEW_CHANNELS" >> $GITHUB_OUTPUT

      - name: Generate README
        run: |
          CHANNELS="${{ steps.validate.outputs.channels }}"
          UPDATED_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          cat > README.md << EOF
          # ðŸ“º IPTV Playlist Generator (Auto Refresh)

          ![Status](https://github.com/${{ github.repository }}/actions/workflows/update-playlist-public.yml/badge.svg)
          ![Channels](https://img.shields.io/badge/channels-${CHANNELS}-success)
          ![Last Updated](https://img.shields.io/badge/updated-${UPDATED_TIME// /-}-blue)

          ## ðŸš€ URL Playlist Tá»± Äá»™ng Cáº­p Nháº­t

          DÃ¡n Ä‘Æ°á»ng link dÆ°á»›i Ä‘Ã¢y vÃ o trÃ¬nh phÃ¡t IPTV cá»§a báº¡n má»™t láº§n duy nháº¥t. Playlist sáº½ tá»± Ä‘á»™ng Ä‘Æ°á»£c lÃ m má»›i.

          \`\`\`
          https://raw.githubusercontent.com/${{ github.repository }}/main/${{ env.OUTPUT_FILENAME }}
          \`\`\`

          ### HÆ°á»›ng dáº«n
          1.  **Sao chÃ©p** Ä‘Æ°á»ng link trÃªn.
          2.  Má»Ÿ trÃ¬nh phÃ¡t IPTV (VLC, Kodi, TiviMate, Perfect Player...).
          3.  Chá»n "Add Playlist from URL" hoáº·c "Má»Ÿ luá»“ng máº¡ng...".
          4.  **DÃ¡n** Ä‘Æ°á»ng link vÃ o vÃ  xÃ¡c nháº­n.

          ---
          *Generated by GitHub Actions*
          EOF
      
      - name: Commit Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ðŸ”„ Update: ${{ steps.validate.outputs.channels }} channels"
          file_pattern: "${{ env.OUTPUT_FILENAME }} README.md iptv_generator.log"
          commit_user_name: IPTV Bot
          commit_user_email: susuint-try@github.com
