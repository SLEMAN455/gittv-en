name: Update IPTV Playlist (High Quality - Auto Refresh)

on:
  schedule:
    - cron: '0 9,21 * * *'
  
  workflow_dispatch:
    inputs:
      mode:
        description: 'Chế độ chạy (normal/quick/express)'
        required: false
        default: 'normal'
        type: choice
        options:
          - normal
          - quick
          - express

permissions:
  contents: write

concurrency:
  group: playlist-update
  cancel-in-progress: false

env:
  PYTHON_VERSION: '3.11'
  OUTPUT_FILENAME: 'playlist.m3u'

jobs:
  update-playlist:
    name: Generate High-Quality Playlist
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Python with Cache
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install Dependencies
        run: pip install -r requirements.txt
      
      - name: Configure Run Mode
        run: |
          MODE="${{ github.event.inputs.mode }}"
          if [ "$MODE" == "quick" ]; then
            sed -i 's/CHANNEL_CHECK_TIMEOUT = 5/CHANNEL_CHECK_TIMEOUT = 3/g' iptv_generator_optimized.py
            sed -i 's/MAX_CONCURRENT_CHECKS = 150/MAX_CONCURRENT_CHECKS = 180/g' iptv_generator_optimized.py
            echo "⚡ Chế độ Quick được kích hoạt."
          elif [ "$MODE" == "express" ]; then
            sed -i 's/CHANNEL_CHECK_TIMEOUT = 5/CHANNEL_CHECK_TIMEOUT = 2/g' iptv_generator_optimized.py
            sed -i 's/MAX_CONCURRENT_CHECKS = 150/MAX_CONCURRENT_CHECKS = 200/g' iptv_generator_optimized.py
            echo "🚀 Chế độ Express được kích hoạt."
          else
            echo "🔄 Chạy ở chế độ Normal (High Quality Mode)."
          fi
      
      - name: Generate High-Quality Playlist
        run: python iptv_generator_optimized.py
      
      - name: Validate New Playlist
        id: validate
        run: |
          if [ ! -f "${{ env.OUTPUT_FILENAME }}" ]; then
            echo "❌ Lỗi: Script không tạo ra tệp playlist.m3u."
            exit 1
          fi
          
          NEW_CHANNELS=$(grep -c "^http" "${{ env.OUTPUT_FILENAME }}" || echo "0")
          if [ $NEW_CHANNELS -lt 30 ]; then
            echo "❌ Xác thực thất bại: Số lượng kênh quá ít ($NEW_CHANNELS)."
            echo "Để bảo toàn chất lượng, lần cập nhật này sẽ bị hủy và giữ lại playlist cũ."
            exit 1
          fi
          
          echo "✅ Playlist mới hợp lệ với $NEW_CHANNELS kênh chất lượng cao."
          echo "channels=$NEW_CHANNELS" >> $GITHUB_OUTPUT

      - name: Generate README
        run: |
          CHANNELS="${{ steps.validate.outputs.channels }}"
          UPDATED_TIME=$(date -u +"%Y-%m-%d %H:%M UTC")
          cat > README.md << EOF
          # 📺 IPTV Playlist Generator (High Quality - Auto Refresh)

          ![Status](https://github.com/${{ github.repository }}/actions/workflows/update-playlist-public.yml/badge.svg)
          ![Channels](https://img.shields.io/badge/channels-${CHANNELS}-success)
          ![Quality](https://img.shields.io/badge/quality-1080p+-blue)
          ![Last Updated](https://img.shields.io/badge/updated-${UPDATED_TIME// /%20}-blue)

          ## 🚀 URL Playlist Chất Lượng Cao

          **Chỉ chứa kênh ≥1080p, ping nhanh, không có kênh chất lượng thấp.**

          \`\`\`
          https://raw.githubusercontent.com/${{ github.repository }}/main/${{ env.OUTPUT_FILENAME }}
          \`\`\`

          ### ✨ Đặc điểm
          - ✅ **Chất lượng:** Tất cả kênh ≥ 1080p (FHD/4K)
          - ⚡ **Tốc độ:** Ping ≤ 3400ms (nhanh hơn 15%)
          - 🚫 **Loại bỏ:** Bangladesh, Belarus, Costa Rica, India, Mexico, Laos
          - 🎯 **Tổng số kênh:** ${CHANNELS} kênh được tuyển chọn

          ### Hướng dẫn sử dụng
          1.  **Sao chép** đường link trên.
          2.  Mở trình phát IPTV (VLC, Kodi, TiviMate, Perfect Player...).
          3.  Chọn "Add Playlist from URL" hoặc "Mở luồng mạng".
          4.  **Dán** đường link vào và xác nhận.

          ### Lịch trình cập nhật
          - Playlist được tự động làm mới **2 lần mỗi ngày** vào lúc **09:00** và **21:00** (giờ UTC).
          - Chỉ giữ lại các kênh đạt tiêu chuẩn chất lượng cao.

          ---
          *Generated by GitHub Actions - High Quality Mode*
          EOF
      
      - name: Commit Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "🔄 Update: ${{ steps.validate.outputs.channels }} HQ channels (≥1080p)"
          file_pattern: "${{ env.OUTPUT_FILENAME }} README.md iptv_generator.log"
          commit_user_name: IPTV Bot
          commit_user_email: actions@github.com
