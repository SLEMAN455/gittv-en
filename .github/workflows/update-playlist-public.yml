name: Update IPTV Playlist (Public URL - Auto Refresh)

on:
  schedule:
    # Chạy 2 lần/ngày vào các thời điểm tối ưu
    - cron: '0 21,9 * * *'
  
  workflow_dispatch:
    inputs:
      mode:
        description: 'Chế độ chạy (normal/quick/express)'
        required: false
        default: 'normal'
        type: choice
        options:
          - normal
          - quick
          - express

permissions:
  contents: write

concurrency:
  group: playlist-update
  cancel-in-progress: false

env:
  PYTHON_VERSION: '3.11'
  OUTPUT_FILENAME: 'playlist.m3u'

jobs:
  update-playlist:
    name: Generate Public Playlist
    runs-on: ubuntu-latest
    timeout-minutes: 25
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          # Lấy lịch sử commit để so sánh chất lượng playlist
          fetch-depth: 2

      - name: Setup Python with Cache
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install Dependencies
        run: pip install -r requirements.txt
      
      - name: Configure Run Mode
        run: |
          MODE="${{ github.event.inputs.mode }}"
          # (Phần cấu hình chế độ chạy giữ nguyên như trước)
          if [ "$MODE" == "quick" ]; then
            sed -i 's/CHANNEL_CHECK_TIMEOUT = 8/CHANNEL_CHECK_TIMEOUT = 6/g' iptv_generator_optimized.py
            sed -i 's/MAX_CONCURRENT_CHECKS = 40/MAX_CONCURRENT_CHECKS = 50/g' iptv_generator_optimized.py
          elif [ "$MODE" == "express" ]; then
            sed -i 's/CHANNEL_CHECK_TIMEOUT = 8/CHANNEL_CHECK_TIMEOUT = 4/g' iptv_generator_optimized.py
            sed -i 's/MAX_CONCURRENT_CHECKS = 40/MAX_CONCURRENT_CHECKS = 60/g' iptv_generator_optimized.py
          fi
      
      - name: Generate New Playlist
        run: python iptv_generator_optimized.py
      
      - name: Validate New Playlist
        id: validate
        run: |
          if [ ! -f "${{ env.OUTPUT_FILENAME }}" ]; then
            echo "❌ Lỗi: Script không tạo ra tệp playlist.m3u."
            exit 1
          fi
          
          NEW_CHANNELS=$(grep -c "^http" "${{ env.OUTPUT_FILENAME }}" || echo "0")
          # Yêu cầu tối thiểu 50 kênh để coi là hợp lệ
          if [ $NEW_CHANNELS -lt 50 ]; then
            echo "❌ Xác thực thất bại: Số lượng kênh quá ít ($NEW_CHANNELS)."
            # Không commit và thoát để giữ lại phiên bản cũ tốt hơn
            exit 1
          fi
          
          echo "✅ Playlist mới hợp lệ với $NEW_CHANNELS kênh."
          echo "channels=$NEW_CHANNELS" >> $GITHUB_OUTPUT

      - name: Generate README
        run: |
          CHANNELS="${{ steps.validate.outputs.channels }}"
          UPDATED_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          cat > README.md << EOF
          # 📺 IPTV Playlist Generator (Auto Refresh)

          ![Status](https://github.com/${{ github.repository }}/actions/workflows/update-playlist-public.yml/badge.svg)
          ![Channels](https://img.shields.io/badge/channels-${CHANNELS}-success)
          ![Last Updated](https://img.shields.io/badge/updated-${UPDATED_TIME// /-}-blue)

          ## 🚀 URL Playlist Tự Động Cập Nhật

          Dán đường link dưới đây vào trình phát IPTV của bạn một lần duy nhất. Playlist sẽ tự động được làm mới.

          \`\`\`
          https://raw.githubusercontent.com/${{ github.repository }}/main/${{ env.OUTPUT_FILENAME }}
          \`\`\`

          ### Hướng dẫn
          1.  **Sao chép** đường link trên.
          2.  Mở trình phát IPTV (VLC, Kodi, TiviMate, Perfect Player...).
          3.  Chọn "Add Playlist from URL" hoặc "Mở luồng mạng...".
          4.  **Dán** đường link vào và xác nhận.

          ---
          *Generated by GitHub Actions*
          EOF
      
      - name: Commit Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "🔄 Update: ${{ steps.validate.outputs.channels }} channels"
          file_pattern: "${{ env.OUTPUT_FILENAME }} README.md iptv_generator.log"
          commit_user_name: IPTV Bot
          commit_user_email: susuint-try@github.com
